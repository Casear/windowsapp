
collie.FPSConsole=collie.Class({INTERVAL_OF_UPDATE_VIEW:60,$init:function(a){this.option({color:"gray",left:10,top:10,isSimple:false,useProfiling:false,useConsole:true,useDrawingCount:false,visible:true,limit:0,start:0});
this.option(a||{});this._initElement();this._bLoaded=false;this._nLastUpdatedFrame=0;this._htInfo={};this._htAverage={};this._htTotal={};
this._htCount={};this._htMin={};this._htMax={};this._htEvent={process:this._onProcess.bind(this),stop:this._onProcess.bind(this)}
},_initElement:function(){this._el=document.createElement("div");this._el.id="fpsconsole";this._el.style.position="relative";
this._el.style.top=this.option("top")+"px";this._el.style.left=this.option("left")+"px";this._el.style.width="220px";this._el.style.height="50px";
this._el.style.font="bold 0.75em Helvetica";this._el.style.lineHeight=1.5;this._el.style.color=this.option("color");this._el.style.zIndex=9999;
this._el.style.display=(this.option("console")?"none":"block");this._el.innerHTML='<b>FPS</b> <span id="_fpsconsole_fps" class="fps"></span><div id="fpsconsole_isNotSimple"><b>Rendering</b> <span id="_fpsconsole_rendering_time" class="rendering_time"></span>ms<br /><b>Frame</b> <span id="_fpsconsole_frame" class="frame"></span><br /><b>Skipped</b> <span id="_fpsconsole_skipped" class="skipped"></span><br /><b>Mode</b> <span id="_fpsconsole_mode" class="mode"></span></div><div id="fpsconsole_drawingCount"><b>draw</b><div id="_fpsconsole_drawingCountContainer"></div></div>'
},load:function(){if(this.option("visible")){document.body.appendChild(this._el);this._elFPS=document.getElementById("_fpsconsole_fps");
this._elRenderingTime=document.getElementById("_fpsconsole_rendering_time");this._elFrame=document.getElementById("_fpsconsole_frame");
this._elSkipped=document.getElementById("_fpsconsole_skipped");this._elMode=document.getElementById("_fpsconsole_mode");this._elDrawingCountContainer=document.getElementById("_fpsconsole_drawingCountContainer");
if(this.option("isSimple")){document.getElementById("fpsconsole_isNotSimple").style.display="none";this._el.style.width="50px";
this._el.style.height="20px"}else{document.getElementById("fpsconsole_isNotSimple").style.display="block";this._el.style.width="220px";
this._el.style.height="50px"}if(this.option("useDrawingCount")){document.getElementById("fpsconsole_drawingCount").style.display="block"
}else{document.getElementById("fpsconsole_drawingCount").style.display="none"}}collie.Renderer.attach(this._htEvent);this._bLoaded=true;
return this},unload:function(){if(this.option("visible")){document.body.removeChild(this._el)}collie.Renderer.detach(this._htEvent);
this._bLoaded=false;return this},getElement:function(){return this._el},_onProcess:function(a){if(this.option("start")>a.frame){return
}this.set(a,a.sType=="stop");if(this.option("limit")&&a.frame>this.option("limit")){collie.Renderer.stop()}},_setValue:function(b){for(var a in b){if((typeof b[a]!="string"&&typeof b[a]!="number")||a=="sType"){continue
}if(this.option("useProfiling")&&typeof this._htInfo[a]=="number"&&!a.toString().match(/^(frame|skippedFrame|beforeFrameTime|duration)$/)){this._htTotal[a]=(this._htTotal[a]?this._htTotal[a]:0)+b[a];
this._htCount[a]=(this._htCount[a]?this._htCount[a]:0)+1;this._htAverage[a]=Math.round((this._htTotal[a]/this._htCount[a])*100)/100;
this._htMin[a]=this._htMin[a]?Math.min(this._htMin[a],b[a]):b[a];this._htMax[a]=this._htMax[a]?Math.max(this._htMax[a],b[a]):b[a]
}this._htInfo[a]=b[a]}},set:function(b,a){this._setValue(b);if(this._nLastUpdatedFrame>b.frame){this._nLastUpdatedFrame=0
}if(a||this._nLastUpdatedFrame+this.INTERVAL_OF_UPDATE_VIEW<=b.frame){this.view()}return this},_getValue:function(c){if(!c){var b="";
for(var a in this._htInfo){if(typeof this._htInfo[a]=="function"){continue}b+=a+" : "+this._getValue(a)+"\n"}return b}else{var b=this._htInfo[c];
if(!this.option("isSimple")&&this.option("useProfiling")&&this._htMin[c]){b+=" (avg "+this._htAverage[c]+", min "+this._htMin[c]+", max "+this._htMax[c]+")"
}return b}},getValue:function(){var a={};for(var b in this._htInfo){a[b]=this._htMin[b]?{value:this._htInfo[b],average:this._htAverage[b],min:this._htMin[b],max:this._htMax[b]}:this._htInfo[b]
}return a},view:function(){if(!this.option("visible")){if(this.option("useConsole")){console.log(this._getValue()+"---")}}else{if(this._bLoaded){this._elFPS.innerHTML=this._getValue("fps");
this._elRenderingTime.innerHTML=this._getValue("renderingTime");this._elFrame.innerHTML=this._getValue("frame");this._elSkipped.innerHTML=this._getValue("skippedFrame");
this._elMode.innerHTML=this._getValue("mode");this._nLastUpdatedFrame=this._htInfo.frame;if(this.option("useDrawingCount")){var c="";
for(var b=0,a=collie.Renderer._aLayerList.length;b<a;b++){c+="#"+b+": "+collie.Renderer._aLayerList[b].drawCount+"<br />"
}this._elDrawingCountContainer.innerHTML=c}}}return this}},collie.Component);(function(){var a={};var c=[];var e=function(g){if(!a[g]){a[g]={name:g,startTime:null,totalTime:0,averageTime:0,count:0}
}};var f=function(g){e(g);if(a[g].startTime===null){a[g].startTime=(+new Date())}};var b=function(g){if(a[g].startTime!==null){a[g].totalTime+=(+new Date())-a[g].startTime;
a[g].count++;a[g].averageTime=a[g].totalTime/a[g].count;a[g].startTime=null}};var d=function(){for(var g in a){c.push(a[g])
}c.sort(function(i,h){return h.totalTime-i.totalTime})};collie.Profiling={setConsole:function(g){this._oConsole=g;this._oConsole.option("isSimple",false);
this._oConsole.option("useProfiling",true);this._oConsole.option("useConsole",false);this._oConsole.option("visible",false)
},load:function(k){if(k){collie.Renderer.attach("process",function(i){if(i.frame>k){collie.Profiling.getResults()}})}for(var h in collie){if(typeof collie[h]=="object"){for(var g in collie[h]){if(!g.toString().match(/^\$super/)&&g!="constructor"&&g!="prototype"&&typeof collie[h][g]=="function"){(function(m,l){var o=m+"_"+l;
var n=collie[m][l];collie[m][l]=function(){f(o);var i=n.apply(this,arguments);b(o);return i}})(h,g)}}}if(typeof collie[h]!="object"){for(var g in collie[h].prototype){if(!g.toString().match(/^\$super/)&&g!="constructor"&&g!="prototype"&&g!="$init"&&typeof collie[h].prototype[g]=="function"){(function(m,l){var o=m+"_"+l;
var n=collie[m].prototype[l];collie[m].prototype[l]=function(){f(o);var i=n.apply(this,arguments);b(o);return i}})(h,g)}}}}},getResults:function(){collie.Renderer.stop();
d();this._showPage()},_showPage:function(){var m=navigator.userAgent;var h=window.devicePixelRatio;var k={width:document.body.clientWidth,height:document.body.clientHeight};
var l=document.createElement("div");l.style.cssText="position:absolute;top:0;left:0;width:"+k.width+"px;height:100%;background-color:#fff;padding:10px;line-height:1.5;font:1em Helvetica;";
var r=document.createElement("div");r.style.cssText="margin-bottom:15px;border-bottom:1px solid #aaa;padding-bottom:15px;";
r.innerHTML='<h1 style="margin-bottom:10px;">Collie Profiling</h1><div style="font-size:0.75em;color:gray;">ratio : '+h+", agent : "+m+"</div>";
l.appendChild(r);if(this._oConsole){this._oConsole.getElement().style.display="none";var s=document.createElement("ul");s.style.marginBottom="15px";
var g=this._oConsole.getValue();for(var n in g){s.innerHTML+='<li style="list-style-type:none;padding:3px;margin-bottom:3px;font-size:0.8em;"><strong>'+n+'</strong> <span style="color:gray;">'+this._oConsole._getValue(n)+"</span></li>"
}l.appendChild(s)}var q=document.createElement("ul");for(var p=0,u=Math.min(c.length,100);p<u;p++){var o=c[p].name.replace(/_/,".");
var t=(Math.round(c[p].averageTime*100)/100)+"ms / "+c[p].totalTime+"ms ("+c[p].count+")";q.innerHTML+='<li style="list-style-type:none;padding:3px;margin-bottom:3px;border-bottom:1px solid #aaa;font-size:0.75em;"><strong>'+o+'</strong> <span style="color:gray;">'+t+"</span></li>"
}l.appendChild(q);document.body.appendChild(l)}}})();